# yaml2pbip Model Configuration Example
# This file defines the semantic model structure including tables, measures, and relationships

version: 1

model:
  name: SalesModel
  culture: en-US

  tables:
    # ========================================
    # Measure Table: Cross-table measures
    # ========================================
    - name: Measure Table
      kind: measureTable
      measures:
        - name: Total Profit
          expression: "SUMX ( FactSales, FactSales[Revenue] - FactSales[Cost] )"
          formatString: "#,0.0"
        
        - name: Profit Margin %
          expression: |
            DIVIDE (
              [Total Profit],
              [Total Revenue],
              0
            ) * 100
          formatString: "0.00%"
        
        - name: YTD Revenue
          expression: |
            TOTALYTD (
              [Total Revenue],
              DimDate[Date]
            )
          formatString: "$#,0"

    # ========================================
    # Dimension Table: Date dimension
    # ========================================
    - name: DimDate
      kind: table
      column_policy: select_only
      columns:
        - name: Date
          dataType: dateTime
        
        - name: Year
          dataType: int64
        
        - name: Quarter
          dataType: int64
        
        - name: Month
          dataType: int64
        
        - name: MonthName
          dataType: string
        
        - name: DayOfWeek
          dataType: int64
        
        - name: DayName
          dataType: string
        
        - name: IsWeekend
          dataType: boolean
      partitions:
        - name: Full
          mode: import
          use: sf_main
          navigation:
            database: SALES
            schema: DIM
            table: DATE
          custom_steps: [ proper_casting ]


    # ========================================
    # Dimension Table: Product dimension
    # ========================================
    - name: DimProduct
      kind: table
      column_policy: select_only
      columns:
        - name: ProductKey
          dataType: int64
        
        - name: ProductID
          dataType: string
        
        - name: ProductName
          dataType: string
        
        - name: Category
          dataType: string
        
        - name: SubCategory
          dataType: string
        
        - name: UnitPrice
          dataType: decimal
          formatString: "$#,0.00"
      partitions:
        - name: Full
          mode: import
          use: sf_main
          navigation:
            database: SALES
            schema: DIM
            table: PRODUCT
          custom_steps: [ proper_casting ]

      measures:
        - name: Product Count
          expression: "COUNTROWS ( DimProduct )"
          formatString: "#,0"

    # ========================================
    # Fact Table: Sales transactions
    # ========================================
    - name: FactSales
      kind: table
      column_policy: keep_all
      columns:
        - name: OrderID
          dataType: int64
        
        - name: OrderLineID
          dataType: int64
        
        - name: OrderDate
          dataType: dateTime
        
        - name: ProductKey
          dataType: int64
        
        - name: Quantity
          dataType: int64
        
        - name: UnitPrice
          dataType: decimal
          formatString: "$#,0.00"
        
        - name: Revenue
          dataType: decimal
          formatString: "$#,0.00"
        
        - name: Cost
          dataType: decimal
          formatString: "$#,0.00"
        
        - name: Discount
          dataType: decimal
          formatString: "$#,0.00"
      
      measures:
        - name: Total Orders
          expression: "DISTINCTCOUNT ( FactSales[OrderID] )"
          formatString: "#,0"
        
        - name: Total Revenue
          expression: "SUM ( FactSales[Revenue] )"
          formatString: "$#,0"
        
        - name: Total Cost
          expression: "SUM ( FactSales[Cost] )"
          formatString: "$#,0"
        
        - name: Total Quantity
          expression: "SUM ( FactSales[Quantity] )"
          formatString: "#,0"
        
        - name: Average Order Value
          expression: |
            DIVIDE (
              [Total Revenue],
              [Total Orders],
              0
            )
          formatString: "$#,0.00"
      
      partitions:
        - name: CurrentYear
          mode: import
          use: sf_main
          nativeQuery: |
            SELECT 
              OrderID,
              OrderLineID,
              OrderDate,
              ProductKey,
              Quantity,
              UnitPrice,
              Revenue,
              Cost,
              Discount
            FROM SALES.FACT.SALES
            WHERE OrderDate >= DATEADD(year, -1, CURRENT_DATE())
              AND OrderDate < CURRENT_DATE()

    # ========================================
    # Calculated Table: Top Products
    # ========================================
    - name: TopProducts
      kind: calculatedTable
      calculatedTableDef:
        expression: |
          TOPN (
            10,
            SELECTCOLUMNS (
              DimProduct,
              "ProductName", DimProduct[ProductName],
              "Category", DimProduct[Category],
              "TotalRevenue", [Total Revenue]
            ),
            [TotalRevenue],
            DESC
          )
        description: "Top 10 products by revenue"
      columns:
        - name: ProductName
          dataType: string
        
        - name: Category
          dataType: string
        
        - name: TotalRevenue
          dataType: decimal
          formatString: "$#,0.00"
      
      measures:
        - name: Top Products Count
          expression: "COUNTROWS ( TopProducts )"
          formatString: "#,0"

    # ========================================
    # Field Parameter: Product Selection
    # ========================================
    - name: ProductParameter
      kind: fieldParameter
      columns:
        - name: ProductKey
          dataType: int64
        
        - name: ProductName
          dataType: string
      
      measures:
        - name: Selected Product Revenue
          expression: |
            IF (
              ISBLANK ( [_SelectedField] ),
              [Total Revenue],
              CALCULATE (
                [Total Revenue],
                [_SelectedField]
              )
            )
          formatString: "$#,0"

    # ========================================
    # Calculation Group: Time Intelligence
    # ========================================
    - name: TimeIntelligence
      kind: calculationGroup
      calculationGroupItems:
        - name: Current Period
          expression: |
            CALCULATE (
              SELECTEDMEASURE (),
              ALL ( DimDate )
            )
          ordinal: 1
        
        - name: Previous Period
          expression: |
            CALCULATE (
              SELECTEDMEASURE (),
              DATEADD ( DimDate[Date], -1, MONTH )
            )
          ordinal: 2
        
        - name: YTD
          expression: |
            CALCULATE (
              SELECTEDMEASURE (),
              DATESYTD ( DimDate[Date] )
            )
          ordinal: 3
        
        - name: YoY Growth %
          expression: |
            VAR CurrentPeriod = CALCULATE (
              SELECTEDMEASURE (),
              ALL ( DimDate )
            )
            VAR PreviousYear = CALCULATE (
              SELECTEDMEASURE (),
              DATEADD ( DimDate[Date], -1, YEAR )
            )
            RETURN
              DIVIDE (
                CurrentPeriod - PreviousYear,
                PreviousYear,
                0
              ) * 100
          formatString: "0.00%"
          ordinal: 4

  # ========================================
  # Relationships
  # ========================================
  relationships:
    # Date relationships
    - from: FactSales[OrderDate]
      to: DimDate[Date]
      cardinality: manyToOne
      crossFilter: single
    
    # Product relationships
    - from: FactSales[ProductKey]
      to: DimProduct[ProductKey]
      cardinality: manyToOne
      crossFilter: single

  # ========================================
  # Security Roles (empty for now)
  # ========================================
  roles: []
